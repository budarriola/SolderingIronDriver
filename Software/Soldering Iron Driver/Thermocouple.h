#ifndef Thermocouple_H
#define Thermocouple_H

#include <avr/pgmspace.h>	//used to store the lookup table in flash instead of ram


// lookup table for k type thermocouple held in flash memory -60F to 1000F in 1 degree increments represented in micro volts
static const int16_t lookuptable[1071] PROGMEM =
{
	-1949, -1969, -1988, -2008, -2028, -2048, -2067, -2087, -2106, -2126, -1749, -1770, -1790, -1810, -1830, -1850, -1869, -1889, -1909, -1929, -1547, -1568, -1588, -1608, -1628, -1649, -1669, -1689, -1709, -1729, -1343, -1363, -1384, 	-1404, -1425, -1445, -1466, -1486, -1507, -1527, -1135, -1156, -1177, -1198, -1218, -1239, -1260, -1281, -1301, -1322, -926, -947, -968, -989, -1010, -1031, -1052, -1073, -1094, -1114, -714, -735, -756, -778, -799, -820, 	-841, -862, -883, -905, -692, -671, -650, -628, -607, -586, -564, -543, -521, -500, -478, -457, -435, -413, -392, -370, -349, -327, -305, -284, -262, -240, -218, -197, -175, -153, -131, -109, -88, -66, -44, -22, 0, 22, 44, 66, 	88, 110, 132, 154, 176, 198, 220, 242, 264, 286, 308, 330, 353, 375, 397, 419, 441, 463, 486, 508, 530, 552, 575, 597, 619, 642, 664, 686, 709, 731, 753,776, 798, 821, 843, 865, 888, 910, 933, 955, 978, 1000, 1023, 1045, 1068, 1090,	 1113, 1136, 1158, 1181, 1203, 1226, 1249, 1271, 1294, 1316, 1339, 1362, 1384, 1407, 1430, 1453, 1475, 1498, 1521, 1543, 1566, 1589, 1612, 1635, 1657, 1680, 1703, 1726, 1749, 1771, 1794, 1817, 1840, 1863, 1886, 1909, 1931, 1954, 1977,	 2000, 2023, 2046, 2069, 2092, 2115, 2138, 2161, 2184, 2207, 2230, 2253, 2276, 2298, 2321, 2344, 2367, 2390, 2413, 2436, 2459, 2483, 2506, 2529, 2552, 2575, 2598, 2621, 2644, 2667, 2690, 2713, 2736, 2759, 2782, 2805, 2828, 2851, 2874,	 2897, 2920, 2944, 2967, 2990, 3013, 3036, 3059, 3082, 3105, 3128, 3151, 3174, 3197, 3220, 3244, 3267, 3290, 3313, 3336, 3359, 3382, 3405, 3428, 3451, 3474, 3497, 3520, 3544, 3567, 3590, 3613, 3636, 3659, 3682, 3705, 3728, 3751, 3774,	 3797, 3820, 3843, 3866, 3889, 3912, 3935, 3958, 3981, 4004, 4027, 4050, 4073, 4096, 4119, 4142, 4165, 4188, 4211, 4234, 4257, 4280, 4303, 4326, 4349, 4372, 4395, 4417, 4440, 4463, 4486, 4509, 4532, 4555, 4578, 4601, 4623, 4646, 4669,	  4692, 4715, 4738, 4760, 4783, 4806, 4829, 4852, 4874, 4897, 4920, 4943, 4965, 4988, 5011, 5034, 5056, 5079, 5102, 5124, 5147, 5170, 5192, 5215, 5238, 5260, 5283, 5306, 5328, 5351, 5374, 5396, 5419, 5441, 5464, 5487, 5509, 5532, 5554,	   5577, 5599, 5622, 5644, 5667, 5690, 5712, 5735, 5757, 5779, 5802, 5824, 5847, 5869, 5892, 5914, 5937, 5959, 5982, 6004, 6026, 6049, 6071, 6094, 6116, 6138, 6161, 6183, 6205, 6228, 6250, 6272, 6295, 6317, 6339, 6362, 6384, 6406, 6429,	   6451, 6473, 6496, 6518, 6540, 6562, 6585, 6607, 6629, 6652, 6674, 6696, 6718, 6741, 6763, 6785, 6807, 6829, 6852, 6874, 6896, 6918, 6941, 6963, 6985, 7007, 7029, 7052, 7074, 7096, 7118, 7140, 7163, 7185, 7207, 7229, 7251, 7273, 7296,	    7318, 7340, 7362, 7384, 7407, 7429, 7451, 7473, 7495, 7517, 7540, 7562, 7584, 7606, 7628, 7650, 7673, 7695, 7717, 7739, 7761, 7783, 7806, 7828,	7850, 7872, 7894, 7917, 7939, 7961, 7983, 8005, 8027, 8050, 8072, 8094, 8116, 8138, 8161, 8183, 8205, 8227, 8250, 8272, 8294, 8316, 8338, 8361, 8383, 8405, 8427, 8450, 8472, 8494, 8516, 8539, 8561, 8583, 8605, 8628, 8650, 8672, 8694,	8717, 8739, 8761, 8784, 8806, 8828, 8851, 8873, 8895, 8918, 8940, 8962, 8985, 9007, 9029, 9052, 9074, 9096, 9119, 9141, 9163, 9186, 9208, 9231, 9253, 9275, 9298, 9320, 9343, 9365, 9388, 9410, 9432, 9455, 9477, 9500, 9522, 9545, 9567,	9590, 9612, 9635, 9657, 9680, 9702, 9725, 9747, 9770, 9792, 9815, 9837, 9860, 9882, 9905, 9927, 9950, 9973, 9995, 10018, 10040, 10063, 10086, 10108, 10131, 10153, 10176, 10199, 10221, 10244, 10267, 10289, 10312, 10334, 10357, 10380,	10402, 10425, 10448, 10471, 10493, 10516, 10539, 10561, 10584, 10607, 10629, 10652, 10675, 10698, 10720, 10743, 10766, 10789, 10811, 10834, 10857, 10880, 10903, 10925, 10948, 10971, 10994, 11017, 11039, 11062, 11085, 11108, 11131,	11154, 11176, 11199, 11222, 11245, 11268, 11291, 11313, 11336, 11359, 11382, 11405, 11428, 11451, 11474, 11497, 11519, 11542, 11565, 11588, 11611, 11634, 11657, 11680, 11703, 11726, 11749, 11772, 11795, 11818, 11841, 11864, 11887,	11910, 11933, 11956, 11978, 12001, 12024, 12047, 12070, 12093, 12116, 12140, 12163, 12186, 12209, 12232, 12255, 12278, 12301, 12324, 12347, 12370, 12393, 12416, 12439, 12462, 12485, 12508, 12531, 12554, 12577, 12600, 12624, 12647,	12670, 12693, 12716, 12739, 12762, 12785, 12808, 12831, 12855, 12878, 12901, 12924, 12947, 12970, 12993, 13016, 13040, 13063, 13086, 13109, 13132, 13155, 13179, 13202, 13225, 13248, 13271, 13294, 13318, 13341, 13364, 13387, 13410,	13433, 13457, 13480, 13503, 13526, 13549, 13573, 13596, 13619, 13642, 13665, 13689, 13712, 13735, 13758, 13782, 13805, 13828, 13851, 13874, 13898, 13921, 13944, 13967, 13991, 14014, 14037, 14060, 14084, 14107, 14130, 14154, 14177,	14200, 14223, 14247, 14270, 14293, 14316, 14340, 14363, 14386, 14410, 14433, 14456, 14479, 14503, 14526, 14549, 14573, 14596, 14619, 14643, 14666, 14689, 14713, 14736, 14759, 14783, 14806, 14829, 14853, 14876, 14899, 14923, 14946,	14969, 14993, 15016, 15039, 15063, 15086, 15109, 15133, 15156, 15179, 15203, 15226, 15250, 15273, 15296, 15320, 15343, 15366, 15390, 15413, 15437, 15460, 15483, 15507, 15530, 15554, 15577, 15600, 15624, 15647, 15671, 15694, 15717,	15741, 15764, 15788, 15811, 15834, 15858, 15881, 15905, 15928, 15952, 15975, 15998, 16022, 16045, 16069, 16092, 16116, 16139, 16163, 16186, 16209, 16233, 16256, 16280, 16303, 16327, 16350, 16374, 16397, 16421, 16444, 16468, 16491,	16515, 16538, 16561, 16585, 16608, 16632, 16655, 16679, 16702, 16726, 16749, 16773, 16796, 16820, 16843, 16867, 16890, 16914, 16937, 16961, 16984, 17008, 17031, 17055, 17078, 17102, 17125, 17149, 17173, 17196, 17220, 17243, 17267,	17290, 17314, 17337, 17361, 17384, 17408, 17431, 17455, 17478, 17502, 17526, 17549, 17573, 17596, 17620, 17643, 17667, 17690, 17714, 17738, 17761, 17785, 17808, 17832, 17855, 17879, 17902, 17926, 17950, 17973, 17997, 18020, 18044,	18068, 18091, 18115, 18138, 18162, 18185, 18209, 18233, 18256, 18280, 18303, 18327, 18351, 18374, 18398, 18421, 18445, 18469, 18492, 18516, 18539, 18563, 18587, 18610, 18634, 18657, 18681, 18705, 18728, 18752, 18776, 18799, 18823,	18846, 18870, 18894, 18917, 18941, 18965, 18988, 19012, 19035, 19059, 19083, 19106, 19130, 19154, 19177, 19201, 19224, 19248, 19272, 19295, 19319, 19343, 19366, 19390, 19414, 19437, 19461, 19485, 19508, 19532, 19556, 19579, 19603,	19626, 19650, 19674, 19697, 19721, 19745, 19768, 19792, 19816, 19839, 19863, 19887, 19910, 19934, 19958, 19981, 20005, 20029, 20052, 20076, 20100, 20123, 20147, 20171, 20194, 20218, 20242, 20265, 20289, 20313, 20336, 20360, 20384,	20407, 20431, 20455, 20479, 20502, 20526, 20550, 20573, 20597, 20621, 20644, 20668, 20692, 20715, 20739, 20763, 20786, 20810, 20834, 20857, 20881, 20905, 20929, 20952, 20976, 21000, 21023, 21047, 21071, 21094, 21118, 21142, 21165,	21189, 21213, 21236, 21260, 21284, 21308, 21331, 21355, 21379, 21402, 21426, 21450, 21473, 21497, 21521, 21544, 21568, 21592, 21616, 21639, 21663, 21687, 21710, 21734, 21758, 21781, 21805, 21829, 21852, 21876, 21900, 21924, 21947,	21971, 21995, 22018, 22042, 22066, 22089, 22113, 22137, 22160, 22184, 22208, 22232, 22255
};

//function prototypes
int adctoTemp(uint16_t rawADC, uint8_t degrees, float degreesfoffset, uint8_t ADCres, float ADCgain, float ADCvref);
uint16_t adctouV(uint16_t rawADC, uint8_t ADCres, float ADCgain, float ADCvref);
uint16_t tempTouV(uint16_t temp);


//returns a f or c value from an adc reading of a k type tc. rawADC is the avraged 10bit adc reading, degrees 1==F 0==C, ADCoffset in f due to powersupply and diffrences in thermocouples (gain is currently about av=111)
int adctoTemp(uint16_t rawADC, uint8_t degrees, float degreesfoffset, uint8_t ADCres, float ADCgain, float ADCvref)
{
	int result=0;
	float uvoltage =rawADC*((ADCvref / pow(2,ADCres))/ADCgain*1000000.0);	//uvoltage holds value in micro volts
	uint16_t intuvoltage=(uint16_t)(uvoltage);//truncate into an integer to speed things up a bit
	intuvoltage += degreesfoffset*23.0;
	
	uint16_t index;
	for (index=0;index<1070;index++)	//look threw table
	{
		if (intuvoltage>=pgm_read_word(&lookuptable[index]) && intuvoltage<=pgm_read_word(&lookuptable[index+1]))		
		{
			result=index-60;
			break;
		}
	}
	
	//if result is in c instead of f convert
	if (!degrees)
	{
		result=(result-32)*(5/9);
	}

	return result;
}



uint16_t adctouV(uint16_t rawADC, uint8_t ADCres, float ADCgain, float ADCvref)
{
	float uvoltage =rawADC*((ADCvref / pow(2,ADCres))/ADCgain*1000000.0);	//uvoltage holds value in micro volts
	uint16_t intuvoltage=(uint16_t)(uvoltage);//truncate into an integer to speed things up a bit
	return intuvoltage;
}

uint16_t tempTouV(uint16_t temp)
{
	uint16_t result;
	result=pgm_read_word(&lookuptable[temp+60]);
	return result;
}

#endif









/*
// lookup table for k type thermocouple held in flash memory 250F to 910F in 1 degree increments represented in micro volts
static const uint16_t lookuptable[661] PROGMEM =
{
	4965, 4988, 5011, 5034, 5056, 5079, 5102, 5124, 5147, 5170, 5192, 5215, 5238, 5260, 5283, 5306, 5328, 5351, 5374, 5396, 5419, 5441, 5464, 5487, 5509, 5532, 5554, 5577, 5599, 5622, 5644, 5667, 5690, 5712, 5735, 5757, 5779, 5802, 5824,
	5847, 5869, 5892, 5914, 5937, 5959, 5982, 6004, 6026, 6049, 6071, 6094, 6116, 6138, 6161, 6183, 6205, 6228, 6250, 6272, 6295, 6317, 6339, 6362, 6384, 6406, 6429, 6451, 6473, 6496, 6518, 6540, 6562, 6585, 6607, 6629, 6652, 6674, 6696,
	6718, 6741, 6763, 6785, 6807, 6829, 6852, 6874, 6896, 6918, 6941, 6963, 6985, 7007, 7029, 7052, 7074, 7096, 7118, 7140, 7163, 7185, 7207, 7229, 7251, 7273, 7296, 7318, 7340, 7362, 7384, 7407, 7429, 7451, 7473, 7495, 7517, 7540, 7562,
	7584, 7606, 7628, 7650, 7673, 7695, 7717, 7739, 7761, 7783, 7806, 7828, 7850, 7872, 7894, 7917, 7939, 7961, 7983, 8005, 8027, 8050, 8072, 8094, 8116, 8138, 8161, 8183, 8205, 8227, 8250, 8272, 8294, 8316, 8338, 8361, 8383, 8405, 8427,
	8450, 8472, 8494, 8516, 8539, 8561, 8583, 8605, 8628, 8650, 8672, 8694, 8717, 8739, 8761, 8784, 8806, 8828, 8851, 8873, 8895, 8918, 8940, 8962, 8985, 9007, 9029, 9052, 9074, 9096, 9119, 9141, 9163, 9186, 9208, 9231, 9253, 9275, 9298,
	9320, 9343, 9365, 9388, 9410, 9432, 9455, 9477, 9500, 9522, 9545, 9567, 9590, 9612, 9635, 9657, 9680, 9702, 9725, 9747, 9770, 9792, 9815, 9837, 9860, 9882, 9905, 9927, 9950, 9973, 9995, 10018, 10040, 10063, 10086, 10108, 10131, 10153,
	10176, 10199, 10221, 10244, 10267, 10289, 10312, 10334, 10357, 10380, 10402, 10425, 10448, 10471, 10493, 10516, 10539, 10561, 10584, 10607, 10629, 10652, 10675, 10698, 10720, 10743, 10766, 10789, 10811, 10834, 10857, 10880, 10903,
	10925, 10948, 10971, 10994, 11017, 11039, 11062, 11085, 11108, 11131, 11154, 11176, 11199, 11222, 11245, 11268, 11291, 11313, 11336, 11359, 11382, 11405, 11428, 11451, 11474, 11497, 11519, 11542, 11565, 11588, 11611, 11634, 11657,
	11680, 11703, 11726, 11749, 11772, 11795, 11818, 11841, 11864, 11887, 11910, 11933, 11956, 11978, 12001, 12024, 12047, 12070, 12093, 12116, 12140, 12163, 12186, 12209, 12232, 12255, 12278, 12301, 12324, 12347, 12370, 12393, 12416,
	12439, 12462, 12485, 12508, 12531, 12554, 12577, 12600, 12624, 12647, 12670, 12693, 12716, 12739, 12762, 12785, 12808, 12831, 12855, 12878, 12901, 12924, 12947, 12970, 12993, 13016, 13040, 13063, 13086, 13109, 13132, 13155, 13179,
	13202, 13225, 13248, 13271, 13294, 13318, 13341, 13364, 13387, 13410, 13433, 13457, 13480, 13503, 13526, 13549, 13573, 13596, 13619, 13642, 13665, 13689, 13712, 13735, 13758, 13782, 13805, 13828, 13851, 13874, 13898, 13921, 13944,
	13967, 13991, 14014, 14037, 14060, 14084, 14107, 14130, 14154, 14177, 14200, 14223, 14247, 14270, 14293, 14316, 14340, 14363, 14386, 14410, 14433, 14456, 14479, 14503, 14526, 14549, 14573, 14596, 14619, 14643, 14666, 14689, 14713,
	14736, 14759, 14783, 14806, 14829, 14853, 14876, 14899, 14923, 14946, 14969, 14993, 15016, 15039, 15063, 15086, 15109, 15133, 15156, 15179, 15203, 15226, 15250, 15273, 15296, 15320, 15343, 15366, 15390, 15413, 15437, 15460, 15483,
	15507, 15530, 15554, 15577, 15600, 15624, 15647, 15671, 15694, 15717, 15741, 15764, 15788, 15811, 15834, 15858, 15881, 15905, 15928, 15952, 15975, 15998, 16022, 16045, 16069, 16092, 16116, 16139, 16163, 16186, 16209, 16233, 16256,
	16280, 16303, 16327, 16350, 16374, 16397, 16421, 16444, 16468, 16491, 16514, 16538, 16561, 16585, 16608, 16632, 16655, 16679, 16702, 16726, 16749, 16773, 16796, 16820, 16843, 16867, 16890, 16914, 16937, 16961, 16984, 17008, 17031,
	17055, 17078, 17102, 17125, 17149, 17173, 17196, 17220, 17243, 17267, 17290, 17314, 17337, 17361, 17384, 17408, 17431, 17455, 17478, 17502, 17526, 17549, 17573, 17596, 17620, 17643, 17667, 17690, 17714, 17738, 17761, 17785, 17808,
	17832, 17855, 17879, 17902, 17926, 17950, 17973, 17997, 18020, 18044, 18068, 18091, 18115, 18138, 18162, 18185, 18209, 18233, 18256, 18280, 18303, 18327, 18351, 18374, 18398, 18421, 18445, 18469, 18492, 18516, 18539, 18563, 18587,
	18610, 18634, 18657, 18681, 18705, 18728, 18752, 18776, 18799, 18823, 18846, 18870, 18894, 18917, 18941, 18965, 18988, 19012, 19035, 19059, 19083, 19106, 19130, 19154, 19177, 19201, 19224, 19248, 19272, 19295, 19319, 19343, 19366,
	19390, 19414, 19437, 19461, 19485, 19508, 19532, 19556, 19579, 19603, 19626, 19650, 19674, 19697, 19721, 19745, 19768, 19792, 19816, 19839, 19863, 19887, 19910, 19934, 19958, 19981, 20005, 20029, 20052, 20076, 20100, 20123
};
*/